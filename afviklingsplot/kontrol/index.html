



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>Kontrol afhængigheder - x86prime</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.30686662.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#kontrol-afhngigheder" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="x86prime" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              x86prime
            </span>
            <span class="md-header-nav__topic">
              
                Kontrol afhængigheder
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="x86prime" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    x86prime
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../x86prime/" title="x86prime" class="md-nav__link">
      x86prime
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Afviklingsplot
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Afviklingsplot
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Introduktion" class="md-nav__link">
      Introduktion
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../pipeline/" title="Simpel pipeline" class="md-nav__link">
      Simpel pipeline
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../superscalar/" title="Superskalar" class="md-nav__link">
      Superskalar
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../anonyme/" title="Avanceret pipeline, anonyme faser" class="md-nav__link">
      Avanceret pipeline, anonyme faser
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../out-of-order/" title="Out-of-order" class="md-nav__link">
      Out-of-order
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Kontrol afhængigheder
      </label>
    
    <a href="./" title="Kontrol afhængigheder" class="md-nav__link md-nav__link--active">
      Kontrol afhængigheder
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#modellering" class="md-nav__link">
    Modellering
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spekulativ-udfrelse" class="md-nav__link">
    spekulativ udførelse
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#modellering" class="md-nav__link">
    Modellering
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spekulativ-udfrelse" class="md-nav__link">
    spekulativ udførelse
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="kontrol-afhngigheder">Kontrol afhængigheder</h1>
<h2 id="modellering">Modellering</h2>
<p>Vi modellerer effekten af hop, kald og retur ved at forsinke <code>F</code>.
For kald og retur skelner vi mellem korrekte og fejlagtige
forudsigelser. For betingede hop skelner vi tillige mellem om
hoppet tages eller ej.</p>
<p>Vi udtrykker effekten ved tildelinger til en ny tidsvariabel: NextF.time
Og for enhver instruktion gælder altid at F.time &gt;= NextF.time</p>
<p>Vi tilføjer en ny fase, <code>B</code>, specifik for betingede hop, kald og retur.
<code>B</code> svarer til <code>X</code> for de aritmetiske instruktioner. <code>B</code> angiver det
tidspunkt, hvor vi <em>afgør</em> om forudsigelser af instruktionen var korrekt
eller ej. Vi tillader at <code>B</code> indtræffer out-of-order i forhold til andre 
typer instruktioner, men kræver det sker in-order i forhold til andre
hop, kald eller retur.</p>
<pre><code>call a,b:   F----QBC
ret  a:     F----QBC
cbcc a,b,x: F----QBC
inorder(B)
</code></pre>

<p>Her er nogle mulige regler for en out-of-order maskine som beskrevet ovenfor</p>
<pre><code>Instruktion  Taget  Forudsagt    Effekt
Call         ja     ja           produce(F+2,pc)
Ret          ja     ja           produce(F+2,pc)
             ja     nej          produce(B+1,pc)
CBcc         nej    ja           - (ikke muligt)
             nej    nej          produce(B+1,pc)
             ja     ja           produce(F+2,pc)
             ja     nej          produce(F+2,pc)
</code></pre>

<p>Husk at <code>pc</code> er vores specielle register til at pege på næste instruktion, så ovenstående peger på hvor hurtigt næste instruktion kan være klar.</p>
<p>Herunder ses to gennemløb af en indre løkke, hvor hop forudsiges korrekt.</p>
<pre><code>                       012345678901234567
loop: movq (r10),r11   F----QAM--C            -- produce(M+2,r11)
      addq $100,r11    F----Q----XC           -- depend(X,r11), produce(X,r11)
      movq r11,(r10)    F----QAM--VC          -- depend(A,r10), depend(V,r11), produce(V,r11)
      addq $8,r10       F----QX----C          -- produce(X,r10)
      cbl  r10,r12,loop  F----QB----C            -- produce(F+2, pc) (forudsagt korrekt taget)
loop: movq (r10),r11       F----QAM--C           -- produce(M+2,r11)
      addq $100,r11        F----Q----XC          -- depend(X,r11), produce(X,r11)
      movq r11,(r10)        F----QAM--VC         -- depend(A,r10), depend(V,r11), produce(V,r11)
      addq $8,r10           F----QX----C         -- produce(X,r10)
      cbl  r10,r12,loop      F----QB----C
</code></pre>

<p>Ydeevne: 5/4 IPC. Læg mærke til at hoppet i denne eksekvering bliver taget korrekt og næste instruktion bliver derfor kun forsinket 2 clock perioder.</p>
<p>På grund af omkostningen ved hop vil en oversætter ofte rulle en løkke-krop
ud en eller flere gange. Herunder ses effekten af en enkelt udrulning</p>
<pre><code>                       012345678901234567
loop: movq (r10),r11   F----QAM--C            -- produce(M+2,r11)
      addq $100,r11    F----Q----XC           -- depend(X,r11), produce(X,r11)
      movq r11,(r10)    F----QAM--VC          -- depend(V,r11), produce(V,r11)
      addq $8,r10       F----QX----C          -- produce(X,r10)
      cbgt  r10,r12,exit F----QB----C         -- forudsagt korrekt ikke taget
      movq (r10),r11     F----QAM---C         -- depend(A,r10), produce(M+2,r11)
      addq $100,r11       F----Q----XC        -- depend(X,r11), produce(X,r11)
      movq r11,(r10)      F----QAM--VC        -- depend(A,r10), depend(V,r11), produce(V,r11)
      addq $8,r10          F----QX----C       -- produce(X,r10)
      cbl  r10,r12,loop    F----QB----C       -- produce(F+2, pc) (forudsagt korrekt taget)
loop: movq (r10),r11         F----QAM--C      -- produce(M+2,r11)
</code></pre>

<p>Ydeevne: 10/6 IPC</p>
<p>En anden teknik til at skjule omkostningen ved tagne hop er at man dimensionerer
forenden af mikroarkitektur (<code>F</code> til <code>Q</code>) lidt større end resten. Her er for eksempel
et afviklingsplot for den ikke udrullede løkke på en maskine der kan håndtere 3
instruktioner samtidigt i <code>F</code> til <code>Q</code>:</p>
<pre><code>                       012345678901234567
loop: movq (r10),r11   F----QAM--C            -- produce(M+2,r11)
      addq $100,r11    F----Q----XC           -- depend(X,r11), produce(X,r11)
      movq r11,(r10)   F----Q-AM--VC          -- depend(V,r11), produce(V,r11)
      addq $8,r10       F----QX----C          -- produce(X,r10)
      cbl  r10,r12,loop F----Q-B----C         -- produce(F+2, pc) (forudsagt korrekt taget)
loop: movq (r10),r11      F----QAM--C            -- depends(A, r10), produce(M+2,r11)
      addq $100,r11       F----Q----XC           -- depend(X,r11), produce(X,r11)
      movq r11,(r10)      F----Q-AM--VC          -- depend(A,r10), depend(V,r11), produce(V,r11)
      addq $8,r10          F----QX----C          -- produce(X,r10)
      cbl  r10,r12,loop    F----Q-B----C
</code></pre>

<p>Ydeevne: 5/3 IPC</p>
<p>Her ses effekten af en forkert forudsigelse:</p>
<pre><code>                       012345678901234567
loop: movq (r10),r11   F----QAM--C            -- produce(M+2,r11)
      addq $100,r11    F----Q----XC           -- depend(X,r11), produce(X,r11)
      movq r11,(r10)    F----QAM--VC          -- depend(V,r11), produce(V,r11)
      addq $8,r10       F----QX----C          -- produce(X,r10)
      cbl  r10,r12,loop  F----QB----C         -- produce(B+1, pc)
loop: movq (r10),r11            F----QAM--C            -- depends(A, r10), produce(M+2,r11)
      addq $100,r11             F----Q----XC           -- depend(X,r11), produce(X,r11)
      movq r11,(r10)             F----QAM--VC          -- depend(A,r10), depend(V,r11), produce(V,r11)
      addq $8,r10                F----QX----C          -- produce(X,r10)
</code></pre>

<p>Ydeevne 5/9 IPC</p>
<p>Jo længere pipeline, jo større omkostning ved forkerte forudsigelser.</p>
<h2 id="spekulativ-udfrelse">spekulativ udførelse</h2>
<p>Det kan ske at <code>B</code> fasen indtræffer meget sent i forhold til udførelsen
af andre instruktioner. Betragt for eksempel nedenstående stump kode</p>
<pre><code>    long v = tab[j];
    if (v &gt; key) {
      *ptr = *ptr + 1; // found it!
    }
</code></pre>

<p>Oversat til x86prime kan det blive til følgende programstump:</p>
<pre><code>        movq (r10,r11,8),r12
        cble r12,r13,.endif
        movq (r15),r14
        addq $1,r14
        movq r14,(r15)
.endif:
</code></pre>

<p>og lad os antage at variablen <code>tab</code> befinder sig i L2-cache, mens området
udpeget af variablen <code>ptr</code> er i L1-cache. Lad os antage at L2-cache tilgang
koster 10 cykler (oveni L1-tilgang).</p>
<pre><code>                              01234567890123456789012
        movq (r10,r11,8),r12  F----QAM------------C
        cble r12,r13,else     F----Q--------------BC
        movq (r15),r14         F----QAM------------C
        addq $1,r14            F----Q----X----------C
        movq r14,(r15)          F----QAM--V---------C
</code></pre>

<p>Det betingede hop afhænger af en instruktion der er nød til at hente en værdi
i L2 og bliver således forsinket så det først kan afgøres i cyklus 20.</p>
<p>Hoppet er forudsagt "ikke taget" og før det afgøres kan de næste tre instruktioner
læse fra L1-cachen, beregne en ny værdi og lægge den i kø til skrivning til L1.</p>
<p>Det går selvsagt ikke an faktisk at opdatere L1, før vi ved om hoppet er
forudsagt korrekt, men alle øvrige aktiviteter kan gennemføres. De instruktioner
som udføres tidligere end et eller flere hop, kald eller retur, som de egentlig
afhænger af, siges at være spekulativt udført. Spekulativ udførelse fjerner en
væsentlig begrænsning på hvor meget arbejde der kan udføres parallelt.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../out-of-order/" title="Out-of-order" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Out-of-order
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>