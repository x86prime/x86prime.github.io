


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.12">
    
    
      
        <title>Kontrol afhængigheder - CompSys@DIKU</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.4dd2dd8d.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#kontrol-afhngigheder" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="CompSys@DIKU" class="md-header-nav__button md-logo" aria-label="CompSys@DIKU">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            CompSys@DIKU
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Kontrol afhængigheder
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="CompSys@DIKU" class="md-nav__button md-logo" aria-label="CompSys@DIKU">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    CompSys@DIKU
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../x86prime/" title="x86prime" class="md-nav__link">
      x86prime
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Afviklingsplot
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Afviklingsplot" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Afviklingsplot
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Introduktion" class="md-nav__link">
      Introduktion
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../pipeline/" title="Simpel pipeline" class="md-nav__link">
      Simpel pipeline
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../superscalar/" title="Superskalar" class="md-nav__link">
      Superskalar
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../anonyme/" title="Avanceret pipeline, anonyme faser" class="md-nav__link">
      Avanceret pipeline, anonyme faser
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../out-of-order/" title="Out-of-order" class="md-nav__link">
      Out-of-order
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Kontrol afhængigheder
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" title="Kontrol afhængigheder" class="md-nav__link md-nav__link--active">
      Kontrol afhængigheder
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#modellering" class="md-nav__link">
    Modellering
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spekulativ-udfrelse" class="md-nav__link">
    spekulativ udførelse
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#modellering" class="md-nav__link">
    Modellering
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spekulativ-udfrelse" class="md-nav__link">
    spekulativ udførelse
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <h1 id="kontrol-afhngigheder">Kontrol afhængigheder</h1>
<h2 id="modellering">Modellering</h2>
<p>Vi modellerer effekten af hop, kald og retur ved at forsinke <code>F</code>.
For kald og retur skelner vi mellem korrekte og fejlagtige
forudsigelser. For betingede hop skelner vi tillige mellem om
hoppet tages eller ej.</p>
<p>Vi udtrykker effekten ved tildelinger til en ny tidsvariabel: NextF.time
Og for enhver instruktion gælder altid at F.time &gt;= NextF.time</p>
<p>Vi tilføjer en ny fase, <code>B</code>, specifik for betingede hop, kald og retur.
<code>B</code> svarer til <code>X</code> for de aritmetiske instruktioner. <code>B</code> angiver det
tidspunkt, hvor vi <em>afgør</em> om forudsigelser af instruktionen var korrekt
eller ej. Vi tillader at <code>B</code> indtræffer out-of-order i forhold til andre 
typer instruktioner, men kræver det sker in-order i forhold til andre
hop, kald eller retur.</p>
<pre><code>call a,b:   F----QBC
ret  a:     F----QBC
cbcc a,b,x: F----QBC
inorder(B)
</code></pre>

<p>Her er nogle mulige regler for en out-of-order maskine som beskrevet ovenfor</p>
<pre><code>Instruktion  Taget  Forudsagt    Effekt
Call         ja     ja           produce(F+2,pc)
Ret          ja     ja           produce(F+2,pc)
             ja     nej          produce(B+1,pc)
CBcc         nej    ja           - (ikke muligt)
             nej    nej          produce(B+1,pc)
             ja     ja           produce(F+2,pc)
             ja     nej          produce(F+2,pc)
</code></pre>

<p>Husk at <code>pc</code> er vores specielle register til at pege på næste instruktion, så ovenstående peger på hvor hurtigt næste instruktion kan være klar.</p>
<p>Herunder ses to gennemløb af en indre løkke, hvor hop forudsiges korrekt.</p>
<pre><code>                       012345678901234567
loop: movq (r10),r11   F----QAM--C            -- produce(M+2,r11)
      addq $100,r11    F----Q----XC           -- depend(X,r11), produce(X,r11)
      movq r11,(r10)    F----QAM--VC          -- depend(A,r10), depend(V,r11), produce(V,r11)
      addq $8,r10       F----QX----C          -- produce(X,r10)
      cbl  r10,r12,loop  F----QB----C            -- produce(F+2, pc) (forudsagt korrekt taget)
loop: movq (r10),r11       F----QAM--C           -- produce(M+2,r11)
      addq $100,r11        F----Q----XC          -- depend(X,r11), produce(X,r11)
      movq r11,(r10)        F----QAM--VC         -- depend(A,r10), depend(V,r11), produce(V,r11)
      addq $8,r10           F----QX----C         -- produce(X,r10)
      cbl  r10,r12,loop      F----QB----C
</code></pre>

<p>Ydeevne: 5/4 IPC. Læg mærke til at hoppet i denne eksekvering bliver taget korrekt og næste instruktion bliver derfor kun forsinket 2 clock perioder.</p>
<p>På grund af omkostningen ved hop vil en oversætter ofte rulle en løkke-krop
ud en eller flere gange. Herunder ses effekten af en enkelt udrulning</p>
<pre><code>                       012345678901234567
loop: movq (r10),r11   F----QAM--C            -- produce(M+2,r11)
      addq $100,r11    F----Q----XC           -- depend(X,r11), produce(X,r11)
      movq r11,(r10)    F----QAM--VC          -- depend(V,r11), produce(V,r11)
      addq $8,r10       F----QX----C          -- produce(X,r10)
      cbgt  r10,r12,exit F----QB----C         -- forudsagt korrekt ikke taget
      movq (r10),r11     F----QAM---C         -- depend(A,r10), produce(M+2,r11)
      addq $100,r11       F----Q----XC        -- depend(X,r11), produce(X,r11)
      movq r11,(r10)      F----QAM--VC        -- depend(A,r10), depend(V,r11), produce(V,r11)
      addq $8,r10          F----QX----C       -- produce(X,r10)
      cbl  r10,r12,loop    F----QB----C       -- produce(F+2, pc) (forudsagt korrekt taget)
loop: movq (r10),r11         F----QAM--C      -- produce(M+2,r11)
</code></pre>

<p>Ydeevne: 10/6 IPC</p>
<p>En anden teknik til at skjule omkostningen ved tagne hop er at man dimensionerer
forenden af mikroarkitektur (<code>F</code> til <code>Q</code>) lidt større end resten. Her er for eksempel
et afviklingsplot for den ikke udrullede løkke på en maskine der kan håndtere 3
instruktioner samtidigt i <code>F</code> til <code>Q</code>:</p>
<pre><code>                       012345678901234567
loop: movq (r10),r11   F----QAM--C            -- produce(M+2,r11)
      addq $100,r11    F----Q----XC           -- depend(X,r11), produce(X,r11)
      movq r11,(r10)   F----Q-AM--VC          -- depend(V,r11), produce(V,r11)
      addq $8,r10       F----QX----C          -- produce(X,r10)
      cbl  r10,r12,loop F----Q-B----C         -- produce(F+2, pc) (forudsagt korrekt taget)
loop: movq (r10),r11      F----QAM--C            -- depends(A, r10), produce(M+2,r11)
      addq $100,r11       F----Q----XC           -- depend(X,r11), produce(X,r11)
      movq r11,(r10)      F----Q-AM--VC          -- depend(A,r10), depend(V,r11), produce(V,r11)
      addq $8,r10          F----QX----C          -- produce(X,r10)
      cbl  r10,r12,loop    F----Q-B----C
</code></pre>

<p>Ydeevne: 5/3 IPC</p>
<p>Her ses effekten af en forkert forudsigelse:</p>
<pre><code>                       012345678901234567
loop: movq (r10),r11   F----QAM--C            -- produce(M+2,r11)
      addq $100,r11    F----Q----XC           -- depend(X,r11), produce(X,r11)
      movq r11,(r10)    F----QAM--VC          -- depend(V,r11), produce(V,r11)
      addq $8,r10       F----QX----C          -- produce(X,r10)
      cbl  r10,r12,loop  F----QB----C         -- produce(B+1, pc)
loop: movq (r10),r11            F----QAM--C            -- depends(A, r10), produce(M+2,r11)
      addq $100,r11             F----Q----XC           -- depend(X,r11), produce(X,r11)
      movq r11,(r10)             F----QAM--VC          -- depend(A,r10), depend(V,r11), produce(V,r11)
      addq $8,r10                F----QX----C          -- produce(X,r10)
</code></pre>

<p>Ydeevne 5/9 IPC</p>
<p>Jo længere pipeline, jo større omkostning ved forkerte forudsigelser.</p>
<h2 id="spekulativ-udfrelse">spekulativ udførelse</h2>
<p>Det kan ske at <code>B</code> fasen indtræffer meget sent i forhold til udførelsen
af andre instruktioner. Betragt for eksempel nedenstående stump kode</p>
<pre><code>    long v = tab[j];
    if (v &gt; key) {
      *ptr = *ptr + 1; // found it!
    }
</code></pre>

<p>Oversat til x86prime kan det blive til følgende programstump:</p>
<pre><code>        movq (r10,r11,8),r12
        cble r12,r13,.endif
        movq (r15),r14
        addq $1,r14
        movq r14,(r15)
.endif:
</code></pre>

<p>og lad os antage at variablen <code>tab</code> befinder sig i L2-cache, mens området
udpeget af variablen <code>ptr</code> er i L1-cache. Lad os antage at L2-cache tilgang
koster 10 cykler (oveni L1-tilgang).</p>
<pre><code>                              01234567890123456789012
        movq (r10,r11,8),r12  F----QAM------------C
        cble r12,r13,else     F----Q--------------BC
        movq (r15),r14         F----QAM------------C
        addq $1,r14            F----Q----X----------C
        movq r14,(r15)          F----QAM--V---------C
</code></pre>

<p>Det betingede hop afhænger af en instruktion der er nød til at hente en værdi
i L2 og bliver således forsinket så det først kan afgøres i cyklus 20.</p>
<p>Hoppet er forudsagt "ikke taget" og før det afgøres kan de næste tre instruktioner
læse fra L1-cachen, beregne en ny værdi og lægge den i kø til skrivning til L1.</p>
<p>Det går selvsagt ikke an faktisk at opdatere L1, før vi ved om hoppet er
forudsagt korrekt, men alle øvrige aktiviteter kan gennemføres. De instruktioner
som udføres tidligere end et eller flere hop, kald eller retur, som de egentlig
afhænger af, siges at være spekulativt udført. Spekulativ udførelse fjerner en
væsentlig begrænsning på hvor meget arbejde der kan udføres parallelt.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../out-of-order/" title="Out-of-order" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Out-of-order
              </div>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.3636a4ec.min.js"></script>
      <script src="../../assets/javascripts/bundle.e9fe3281.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.5eca75d3.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>