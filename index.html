


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.12">
    
    
      
        <title>CompSys@DIKU</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.4dd2dd8d.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="css/extra.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#x86prime" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="." title="CompSys@DIKU" class="md-header-nav__button md-logo" aria-label="CompSys@DIKU">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            CompSys@DIKU
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Home
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="CompSys@DIKU" class="md-nav__button md-logo" aria-label="CompSys@DIKU">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    CompSys@DIKU
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Home
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="." title="Home" class="md-nav__link md-nav__link--active">
      Home
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building" class="md-nav__link">
    Building
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generating-x86-assembler" class="md-nav__link">
    Generating x86 assembler
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#translating-x86-into-prime-x86prime" class="md-nav__link">
    Translating x86 into prime (x86prime)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#encoding-into-hex-format" class="md-nav__link">
    Encoding into hex format
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running" class="md-nav__link">
    Running
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generating-a-tracefile" class="md-nav__link">
    Generating a tracefile
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#limitations-to-cross-assembling" class="md-nav__link">
    Limitations to cross-assembling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-modelling" class="md-nav__link">
    Performance modelling
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="x86prime/" title="x86prime" class="md-nav__link">
      x86prime
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Afviklingsplot
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Afviklingsplot" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Afviklingsplot
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="afviklingsplot/" title="Introduktion" class="md-nav__link">
      Introduktion
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="afviklingsplot/pipeline/" title="Simpel pipeline" class="md-nav__link">
      Simpel pipeline
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="afviklingsplot/superscalar/" title="Superskalar" class="md-nav__link">
      Superskalar
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="afviklingsplot/anonyme/" title="Avanceret pipeline, anonyme faser" class="md-nav__link">
      Avanceret pipeline, anonyme faser
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="afviklingsplot/out-of-order/" title="Out-of-order" class="md-nav__link">
      Out-of-order
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="afviklingsplot/kontrol/" title="Kontrol afhængigheder" class="md-nav__link">
      Kontrol afhængigheder
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building" class="md-nav__link">
    Building
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generating-x86-assembler" class="md-nav__link">
    Generating x86 assembler
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#translating-x86-into-prime-x86prime" class="md-nav__link">
    Translating x86 into prime (x86prime)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#encoding-into-hex-format" class="md-nav__link">
    Encoding into hex format
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running" class="md-nav__link">
    Running
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generating-a-tracefile" class="md-nav__link">
    Generating a tracefile
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#limitations-to-cross-assembling" class="md-nav__link">
    Limitations to cross-assembling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-modelling" class="md-nav__link">
    Performance modelling
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <h1 id="x86prime">x86prime</h1>
<p>A few tools for our x86 subset, x86prime, known as just "prime"</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>Install ocaml and opam. This installs the default compiler version for the system,
which may not be recent enough. Upgrade this to version 4.07, Then use opam to
install menhir and ocamlbuild.</p>
<p>On debian based linux this is</p>
<pre><code>&gt; sudo apt install ocaml opam
&gt; opam init -a
</code></pre>

<p>On some systems, the default ocaml version is too old. Use "ocaml --version"
to find which version you have. If you have something before 4.05.0, you need
to upgrade. Latest version is 4.07.0. To upgrade do:</p>
<pre><code>&gt; opam switch 4.07.0
[at this point you may be asked to run &quot;eval 'opam config env'&quot; - do it]
</code></pre>

<p>You may have to use "opam switch create" instead of just "opam switch"</p>
<p>On some systems, this is not enough, and we recommend that you exit your shell,
then restart it before proceeding</p>
<p>While OCaml 4.05 works, it produces a lot of warnings. If you'd rather have
a clean build process, upgrade to 4.07.0 as described above.</p>
<pre><code>&gt; opam install menhir ocamlbuild
</code></pre>

<h2 id="building">Building</h2>
<p>The script "buildall.sh" will build 4 tools:</p>
<ul>
<li>primify, a tool which translates real x86 assembler into prime assembler</li>
<li>prasm, the assembler, a tool which encodes prime assembler into a format known as "hex"</li>
<li>prun, a tool which reads hex files and runs them</li>
<li>prerf, like prun, but collect performance statistics</li>
</ul>
<p>The tools will be linked from the "bin" subdirectory.</p>
<pre><code>&gt; ./buildall.sh
</code></pre>

<p>If by accident you have built part of the program using an old version, you
may get an error during build indicating a version problem with part of the
project. If this happens, remove the "_build" subdirectory.</p>
<p>And build again.</p>
<h2 id="generating-x86-assembler">Generating x86 assembler</h2>
<p>x86 assembler is in files with suffix ".s"</p>
<p>You can write one yourself. Or generate one from a program written in "C"
using a C-compiler.</p>
<pre><code>&gt; gcc -S -Og -fno-optimize-sibling-calls my_program.c
</code></pre>

<h2 id="translating-x86-into-prime-x86prime">Translating x86 into prime (x86prime)</h2>
<p>The "primify" program will translate an x86 assembler source file into
correspondingly named ".prime" files.</p>
<pre><code>&gt; bin/primify my_program.s
</code></pre>

<p>This results in a new file, "my_program.prime"</p>
<h2 id="encoding-into-hex-format">Encoding into hex format</h2>
<p>The simulators cannot directly read the symbolic prime assembler. You need to
assemble it into hex-format. Use</p>
<pre><code>&gt; bin/prasm my_program.prime
</code></pre>

<p>This produces "my_program.hex", which can be inspected to learn how the prime
program is encoded in numbers.</p>
<p>It also produces "my_program.sym", which is a list of symbols. This is used by
the simulator to allow you to pick which part of the code to execute.</p>
<h2 id="running">Running</h2>
<p>Programs are simulated by "prun"</p>
<pre><code>&gt; bin/prun my_program.hex my_start_function
</code></pre>

<p>Here, the label "my_start_function" must have been defined by the original ".prime"
program.</p>
<p>Without more options, the simulation is silent. To see what happens, add "-show" option</p>
<p>Sit back, relax and watch the blinkenlights.</p>
<h2 id="generating-a-tracefile">Generating a tracefile</h2>
<p>A tracefile records all changes to memory and register made by your program.
You request a tracefile by the "-tracefile" option:</p>
<pre><code>&gt; bin/prun my_program.s my_start_function -tracefile prog.trc
</code></pre>

<p>The subdirectory "examples" includes an example C program (bubblesort.c)
which can be used as introduction to the tools. It has 2 entry-points, "run"
and "run2". If you use "run" it will silently input an integer from the keyboard.
If running it seems to just hang, try providing a small number and press enter.
If you use "run2", it will instead try to access any command line arguments.
To pass command line arguments into the simulated program, just add them to 
the command line after all the other arguments. The bubblesort.c program
illustrates how the program can access the additional arguments, see the "run2"
function.</p>
<h2 id="limitations-to-cross-assembling">Limitations to cross-assembling</h2>
<p>The translation from x86 to prime is not perfect.</p>
<ul>
<li>
<p>When gcc optimizes heavily ("-O2, -O3"), the code patterns generated will not
   be translated correctly. In most cases primify will stop with an exception. 
   We believe "-Og" to be working reasonably well, so stick to that.</p>
</li>
<li>
<p>Tail-call optimization will result in code, which cannot be correctly translated
   into "prime", worse: this currently goes undetected - to disable it use "-fno-optimize-sibling-calls"</p>
</li>
<li>
<p>When gcc needs to use almost all registers in a function, translation will either fail
   or just be incorrect.</p>
</li>
<li>
<p>Using combinations of signed and unsigned longs may not be handled correctly.</p>
</li>
<li>
<p>Using constants which cannot be represented in 32-bit 2-complement form
   may not be handled correctly.</p>
</li>
<li>
<p>Larger "switch" statements can not be translated</p>
</li>
</ul>
<p>In short, we advise you to check the translation result for correctness instead
of blindly trusting it.</p>
<h2 id="performance-modelling">Performance modelling</h2>
<p>The "prerf" tool runs a program much like "prun", but includes a performance model.</p>
<p>The model include a selection of branch predictors, a return predictor and 2 configurable
levels of cache.</p>
<p>It supports 3 different microarchitectures:</p>
<ul>
<li>A simle scalar pipeline.</li>
<li>A 3-way in-order superscalar pipeline.</li>
<li>A 3-way out-of-order (superscalar) pipeline.</li>
</ul>
<p>There are separate primary caches for instruction and data:</p>
<ul>
<li>Access latency i 3 cycles, fully pipelined.</li>
<li>Size 16K, 4-way associative, 32-byte blocks</li>
</ul>
<p>The primary caches are backed by a secondary cache:</p>
<ul>
<li>Access latency 12 cycles (on top of the 3 cycles in L1)</li>
<li>Size 128K, 4-way associative, 32-byte blocks</li>
</ul>
<p>The main memory is an additional 100 cycles away.</p>
<p>The "prerf" tool support generation of execution graphs (da: "afviklingsplot").</p>
<p>Some options:</p>
<ul>
<li>"-show" display execution graph</li>
<li>"-profile" display execution profile. Shows the execution count and average
   execution latency for each instruction.</li>
<li>"-help" show list of options. Use this to see options for selecting
   performance model details.</li>
<li>"-print_config" show configuration of microarchitecture and memory hierachy</li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
        
          <a href="x86prime/" title="x86prime" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                x86prime
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="assets/javascripts/vendor.3636a4ec.min.js"></script>
      <script src="assets/javascripts/bundle.e9fe3281.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: ".",
          features: [],
          search: Object.assign({
            worker: "assets/javascripts/worker/search.5eca75d3.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>